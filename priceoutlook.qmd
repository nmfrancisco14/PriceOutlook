---
title: "Rice Price Outlook"
subtitle: "Trends and Implications"
author: "Data Analytics Center"
institute: "Philippine Rice Research Institute"
# format: revealjs
format:
  revealjs:
    css: custom-styles.css
    touch: true
    controls: true
    slide-number: true
    transition: fade
    chalkboard: 
      buttons: false
    logo: www/dac.png
    footer: "PhilRice Data Analytics Center"
execute: 
  echo: false
  warning: false
  message: false
  freeze: auto
---

```{r}
#| label: setup
#| echo: false

library(tidyverse)
library(DT)
library(htmltools)
library(plotly)
library(jsonlite)
library(httr)
library(DiagrammeR)
library(lmtest)
library(knitr)

```

```{r}
#|label: data_fetching
#|echo: false

data_api <- function(url, key, mute_onSuccess=TRUE) {
  response <- POST(
    url,
    add_headers("Content-Type" = "application/json"),
    body = list(key = key),  # Pass the list as the body
    encode = "json"  # Ensure the body is encoded as JSON
  )
  if (status_code(response) == 200) {
    
    if (!mute_onSuccess){
      print("Request was successful!")
    }
    
    data <- content(response, "text", encoding = "UTF-8")
    json_data <- fromJSON(data, flatten = TRUE)
    data_df <- as.data.frame(json_data$data)
    
    if (!mute_onSuccess){
      print(head(data_df))
    }
    
  } else {
    print(paste("Request failed with status:", status_code(response)))
    print(content(response, "text", encoding = "UTF-8"))  # Print server error message
  }
  
  return(data_df)
}

#key
key <-  "cddcc4f040befb5ecc594aa9cb926379"

url_list <-  list(
  wholesale_prices = "https://ricelytics.philrice.gov.ph/data_lake/api/wholesale_prices",
  fao_fob_prices = "https://ricelytics.philrice.gov.ph/data_lake/api/fob_prices",
  exrates = "https://ricelytics.philrice.gov.ph/data_lake/api/exchange_rate",
  retail_prices= "https://ricelytics.philrice.gov.ph/data_lake/api/retail_prices",
  farmgate_prices= "https://ricelytics.philrice.gov.ph/data_lake/api/farmgate_prices",
  vfa_fob_prices = "https://ricelytics.philrice.gov.ph/data_lake/api/fob_prices_vfa"
)



data <- lapply(url_list, function(x) data_api(x, key))

flag_if_late <- function(date) {
  delay <- interval(date, Sys.Date()) %/% months(1)
  if (delay > 0) {
    paste0(as.character(date), strrep("*", delay))
  } else {
    as.character(date)
  }
}

mostrecentdate_api <- lapply(data, function(x) x |> 
                               slice_max(order_by = id) |> 
                               pull(monthyr) |> 
                               as.Date("%m/%d/%Y")
  )
mostrecentdate_api_flagged <- lapply(mostrecentdate_api,flag_if_late)
data_external <- list()


# data_external[["stocks"]] <-  read_csv("external_data/stocks.csv") |> 
#   mutate(mth = match(Month,month.name),
#          date = ymd(paste(Year,mth,"01"))) |> 
#   select(-c(Year,Month,mth)) |> 
#   relocate(date,.before=1)

# 
# data_external[["riceinf"]] <-  read_csv("external_data/riceinflation.csv") |>
#   mutate(mth = match(Period,month.abb),
#          date = ymd(paste(Year,mth,"01"))) |>
#   select(-c(Year,Period,mth)) |>
#   relocate(date,.before=1)
# 
# saveRDS(data_external[["riceinf"]],"external_data/riceinflation.rds")

# data_external[["imports"]] <-  read_csv("external_data/imports.csv") |>
#   mutate(mth = match(Month,month.abb),
#          date = ymd(paste(Year,mth,"01"))) |>
#   select(date,Imports) |>
#   relocate(date,.before=1)
# 
# saveRDS(data_external[["imports"]] ,"external_data/imports.rds")


data_external[["riceinf"]] <- readRDS("external_data/riceinflation.rds")


data_external[["stocks"]] <- readRDS("external_data/stocks.rds")

data_external[["imports"]] <- readRDS("external_data/imports.rds")

update_msg <- 
paste("Most recent DATA as of: ", Sys.Date(),
          "\nFROM DATA LAKE APIs",
          "\n--1. PSA Wholesale Prices: ", mostrecentdate_api_flagged$wholesale_prices,
          "\n--2. PSA Retail Prices: ", mostrecentdate_api_flagged$retail_prices,
          "\n--3. FAO FOB prices: ", mostrecentdate_api_flagged$fao_fob_prices,
          "\n--4. VFA FOB prices: ", mostrecentdate_api_flagged$vfa_fob_prices,
          "\n--5. BSP Exchnge rates: ", mostrecentdate_api_flagged$exrates,
          "\n--6. PSA Farmgate Prices: ", mostrecentdate_api_flagged$farmgate_prices,
          "\n\n",
          "FROM app local files",
      "\n--1. PSA rice total stocks: ", flag_if_late(data_external[["stocks"]] |> 
                                                       filter(Stock=="Total") |> na.omit() |> slice_max(order_by = date) |> pull(date)),
      "\n--2. PSA rice inflation: ",
      flag_if_late(data_external[["riceinf"]] |>
                     slice_max(order_by = date) |> pull(date)),
      "\n--3. PSA/BOC Imports: ",
      flag_if_late(data_external[["imports"]] |>
                     slice_max(order_by = date) |> pull(date)),
      
      "\n\n* Each asterisk (*) indicates the data is late by one month."
      
  )

message(update_msg)
```

```{r}
#| label: data_editing
#| echo: false

calculate_ipp <- function(fob,
                          importation_cost=62.42,
                          exchange_rate,
                          tariff_rate=0.15, 
                          local_transpo=1443,
                          milling_recovery=.63,
                          total_marketing_cost=9.5) 
{cif <- fob + importation_cost
tariff_amount <- (tariff_rate) *(cif *exchange_rate)
ipp_ton <- ((cif * exchange_rate) + tariff_amount + local_transpo)


ipp_ton / 1000

}
  

data_edited <- list()

data_edited[["wholesale_prices"]] <- 
  data$wholesale_prices |> 
  mutate(date = mdy(monthyr)) |> 
  mutate_at(vars(wmr,rmr),as.numeric) |> 
  select(-c(monthyr,created_at,updated_at)) |> 
  relocate(date,.before=1) |> 
  pivot_longer(c(wmr,rmr), names_to = 'type',values_to = 'price') |> 
  arrange(date, type)

data_edited[["retail_prices"]] <- 
  data$retail_prices |> 
  mutate(date = mdy(monthyr)) |> 
  mutate_at(vars(wmr,rmr),as.numeric) |> 
  select(-c(monthyr,created_at,updated_at)) |> 
  relocate(date,.before=1) |> 
  pivot_longer(c(wmr,rmr), names_to = 'type',values_to = 'price') |> 
  arrange(date, type)
  
data_edited[["farmgate_prices"]] <- 
  data$farmgate_prices |> 
  mutate(date = mdy(monthyr),
         farmgate = as.numeric(farmgate),
         farmgate_rice = farmgate/0.63) |> 
  select(-c(monthyr,created_at,updated_at)) |> 
  relocate(date,.before=1) |> 
  arrange(date)


data_edited[["farmgate_prices"]] <- 
  data$farmgate_prices |> 
  mutate(date = mdy(monthyr),
         farmgate = as.numeric(farmgate),
         farmgate_rice = farmgate/0.63) |> 
  select(-c(monthyr,created_at,updated_at)) |> 
  relocate(date,.before=1) |> 
  arrange(date)

data_edited[["ipp"]] <- 
  data$fao_fob_prices |>
  left_join(data$exrates |> select(monthyr,exrates), by="monthyr") |> 
  mutate(date =mdy(monthyr),
         price = as.numeric(value),
         exrates = as.numeric(exrates)) |> 
    select(-c(monthyr,value,created_at,updated_at)) |> 
  relocate(date,.before=1) |>
  mutate(ipp = pmap_dbl(list(price,exrates),
                        function(price,exrates)
                          calculate_ipp(fob = price, exchange_rate = exrates)
  )
  )
  
data_edited[["ipp_ave"]] <- 
  data_edited[["ipp"]] |>
  reframe(price = mean(ipp,na.rm=TRUE), .by = date)


pricedata_comb <-
data_edited$ipp_ave |> 
  rename(ipp=price) |> 
  left_join(data_edited$retail_prices |> filter(type=="rmr") |> select(date,rprice=price)) |> 
  
  left_join(data_edited$wholesale_prices |> filter(type=="rmr") |> select(date,wprice=price)) |> 
  
  left_join(data_edited$farmgate_prices |> select(date,farmgate)) |> 
  left_join(data_edited$ipp |> filter(type=="Vietnam 25%") |> select(date,viet_price=price)) |> 
  left_join(data_edited$ipp |> filter(type=="Thai 25%") |> select(date,thai_price=price)) |> 
  left_join(data_edited$ipp |> filter(type=="Pakistan 25%") |> select(date,pak_price=price))

pricedata_yoy <- 
pricedata_comb |> 
  arrange(date) |> 
  mutate(
    across(.cols =ipp:pak_price, 
           .fns = ~ ((. / lag(., 12)) - 1)*-100, #transform to negative
           .names = "{.col}_yoy")
  )
  # filter(date>=ymd("2025-01-01"))



base_plot <- 
plot_ly(width="1000",height="500") %>%
  add_lines(data =data_edited[["wholesale_prices"]] |> 
              filter(type =="rmr"),
            x = ~date,
            y = ~price,
            legendgroup = "domestic prices",
            name = "Wholesale Price (RMR)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "darkorange")
  ) |> 
  add_lines(data =data_edited[["retail_prices"]] |> 
              filter(type =="rmr"),
            x = ~date,
            y = ~price,
            legendgroup = "domestic prices",
            name = "Retail Price (RMR)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "darkgreen")
  ) |> 
  add_lines(data =  data_edited[["farmgate_prices"]],
            x = ~date,
            legendgroup = "domestic prices",
            y = ~farmgate_rice,
            name = "Farmgate price (rice equivalent)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "blue")) |> 
  add_lines(data =data_edited[["ipp_ave"]],
            x=~date,
            y=~price,
            legendgroup = "global prices",
            name = "Average Import parity Price (IPP) across major importing countries",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "black", dash = "dash")) |>
    add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Vietnam 25%"),
            x=~date,
            y=~ipp,
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#FF3F3F", dash = "dash")) |>
      add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Thai 25%"),
            x=~date,
            y=~ipp,
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#65DA65", dash = "dash")) |>
      add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Pakistan 25%"),
            x=~date,
            y=~ipp,
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#EE82EE", dash = "dash")) |>
layout(hovermode='x unified',
         xaxis = list(title = "Date",visible = T , showgrid=T),
         yaxis = list(title = "Rice Price (‚Ç±/kg)",visible =T , showgrid=T),
         yaxis2 = list(
           title = list(text = "Farmgate price",
                        standoff = 20),
           overlaying = "y",
           side = "right",
           titlefont = list(size = 12),
           tickfont = list(size = 10),
           visible =T,
           automargin = T,
           showgrid=T
         ),
       legend = list(
         x=0,
         y=-0.5,
         xanchor='left',
         yanchor='top',
         orientation = 'h'
       ),
       
         showlegend = T) |> 
  rangeslider()


ipp_spikes <- ymd(c("2023-08-01","2024-01-01","2024-06-01","2024-12-01"))

```

## Global and Local Price Trends {.tiny-text auto-animate="true"}

::: r-stack
::: {.fragment fragment-index="1"}
::: {.fragment .fade-out fragment-index="2"}
Historical trends (2016-2025) of local rice prices (farmgate, retail and wholesale) and global import parity prices.
:::
:::

::: {.fragment .fade-in fragment-index="2"}
::: {.fragment .fade-out fragment-index="4"}
Global and local rice price trends are **synchronized with delayed responses**
:::
:::

::: {.fragment .fade-in fragment-index="4"}
Global price transmission visually noticeable for **two months after the spike**.
:::
:::

::: r-stack
::: {.fragment fragment-index="1"}
```{r}
#| label: pricetrends
#| data-id: plot


base_plot

```
:::

::: {.fragment fragment-index="2"}
```{r}
#| label: pricetrends_recent
#| data-id: plot

base_plot |> 
  layout(xaxis=list(range = c("2023-06-01", "2025-06-01")))

```
:::

::: {.fragment .fade-in fragment-index="3"}
```{r}
#| label: withspikes
#| data-id: plot


spike_plot <- 
base_plot |> 
    layout(
      xaxis=list(range = c("2023-06-01", "2025-06-01")),
    shapes = c(
      # 1) vertical dashed lines
      lapply(ipp_spikes, function(d) list(
        type = "line",
        x0 = d, x1 = d,
        y0 = 0, y1 = 1,
        yref = "paper",
        line = list(color = "red", dash = "dot")
      ))),
    annotations = c(
      # 3a) ‚ÄúGlobal Price Spike‚Äù labels above the dashed lines
      lapply(ipp_spikes, function(d) list(
        x        = d,
        y        = 1.05,
        xref     = "x",
        yref     = "paper",
        text     = "Global Price Spike",
        showarrow= FALSE,
        font     = list(size = 10, color = "red")
      ))
    )
  )

spike_plot

```
:::

::: {.fragment .fade-in fragment-index="4"}
```{r}
#| label: withdelayedresponse
#| data-id: plot

 lag_plot <- 
  base_plot |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    shapes = c(
      # vertical dashed lines
      lapply(ipp_spikes, function(d) list(
        type = "line",
        x0 = d, x1 = d,
        y0 = 0, y1 = 1,
        yref = "paper",
        line = list(color = "red", dash = "dot")
      )),
      # shaded 2‚Äëmonth rectangles
      lapply(ipp_spikes, function(d) {
        start <- as.Date(d)
        end   <- start %m+% months(2)
        list(
          type      = "rect",
          x0        = start,
          x1        = end,
          y0        = 0,
          y1        = 1,
          yref      = "paper",
          fillcolor = "rgba(200,200,200,0.2)",
          line      = list(width = 0)
        )
      })
    ),
    #annotations
    annotations = c(
      # ‚ÄúGlobal Price Spike‚Äù labels above the dashed lines
      lapply(ipp_spikes, function(d) list(
        x        = d,
        y        = 1.05,
        xref     = "x",
        yref     = "paper",
        text     = "Global Price Spike",
        showarrow= FALSE,
        font     = list(size = 10, color = "red")
      )),
      #shaded annot
      lapply(ipp_spikes, function(d) {
        mid   <- as.Date(d) + months(1)
        list(
          x         = as.character(mid),
          y         = 0.5,
          xref      = "x",
          yref      = "paper",
          textangle = -90,
          text      = "Delayed response to local price",
          showarrow = FALSE,
          font      = list(size =  11, color = "grey20"),
          align     = "center"
        )
      })
    )
  )

lag_plot

```
:::
:::

<!-- ::: {.horizontal-legend .fragment fragment-index="1" style="display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; margin-top: 0.5rem; gap: 0.2rem;"} -->
<!-- ::: {style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;"} -->
<!-- Wholesale Price (RMR) -->

<!-- Retail Price (RMR) -->

<!-- Farmgate price (rice equivalent) -->
<!-- ::: -->

<!-- ::: {style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 0.1rem;"} -->
<!-- Average Import parity Price (IPP) across major importing countries -->

<!-- Vietnam 25% IPP -->

<!-- Thai 25% IPP -->

<!-- Pakistan 25% IPP -->
<!-- ::: -->
<!-- ::: -->

## Evidence of Price transmission {.tiny-text auto-animate="true"}

::: r-stack
::: {.fragment fragment-index="1"}
::: {.fragment .fade-out fragment-index="2"}
Using Cross-Correlation function (CCF) to detect time lag effects of global rice prices or delayed response of local rice prices
:::
:::

::: {.fragment .fade-in-then-out .tiny-text fragment-index="2"}
### Average IPP price (Global) ‚Üí Local Retail price

CCF plot shows that the Average IPP prices significantly leads ( *affect* ) local rice retail price by up to **9 months**, with the strongest effect at lag **0 to +4**, and still meaningful influence up to lag **6--9**.

No substantial correlation observed on negative lags, ruling out local retail prices driving global trends.
:::

::: {.fragment .fade-in-then-out .tiny-text fragment-index="3"}
### Average IPP price (Global) ‚Üí Local Farmgate price

CCF plot shows that the Average IPP prices significantly leads ( *indirectly affect* ) local farmgate price by up to **10 months**, with the strongest effect at lag **0 to +3**, and still meaningful influence up to lag **6** with fading impact from **8 - 10** months.

No reason to believe that farmgate prices leads IPP prices, since it's economical implausible (Philippines being a price taker). Therefore, substantial correlation observed on negative lags can be ignored and might just be a result of shared long-term trend and/or spurious correlation.
:::

::: {.fragment .fade-in-then-out .extra-tiny-text fragment-index="4"}
### Local Retail price ‚Üî Local Farmgate price

The CCF plot reveals a **two-way relationship** between local retail and farmgate rice prices, with both series responding rapidly to each other's changes.

However, retail prices appear to lead farmgate prices more strongly, with the highest correlations observed at lag **0 to +2**, and a meaningful influence extending up to **6 months**.

In contrast, farmgate prices show a weaker and shorter lead, potentially influencing retail prices by only up to **1 month**.

This asymmetry, combined with the strong correlation between global prices (IPP) and retail prices, supports the conclusion that **global price movements primarily influence farmgate prices indirectly---through their immediate impact on retail markets**.
:::

::: {.tiny-text .fragment .fade-in-then-out fragment-index="5"}
Results from the Granger causality test provide sufficient evidence that global rice prices (as estimated by the average Import Parity Price or IPP) Granger-cause local retail prices, indicating that global price movements have a statistically significant influence on retail markets within a 2-month window.

Similarly, local retail prices Granger-cause farmgate prices, with effects unfolding over a 6-month period, suggesting that price changes at the consumer level gradually influence prices received by farmers.
:::

::: {.tiny-text .fragment .fade-in-then-out fragment-index="6"}
In contrast, while the cross-correlation function (CCF) reveals a strong association between global and farmgate prices, the Granger causality test does not detect a direct predictive relationship.

This divergence suggests that the observed correlation may result from indirect transmission, where global prices influence farmgate prices only through their effect on retail prices.
:::
:::

::: r-stack
::: {.fragment fragment-index="1"}
::: {.fragment .fade-out fragment-index="3"}
```{r}
#|label: ccf1


ccf_ipp_rprice <- ccf(pricedata_comb$ipp,pricedata_comb$rprice,plot = F, lag.max = 12)

ccf_ipp_fprice <- ccf(pricedata_comb$ipp,pricedata_comb$farmgate,plot = F)

ccf_rprice_fprice <- ccf(pricedata_comb$rprice,pricedata_comb$farmgate,plot = F)


ccfDF_ipp_rprice <- data.frame(
  Lag = ccf_ipp_rprice$lag,
  Correlation = ccf_ipp_rprice$acf
)

plot_ly(ccfDF_ipp_rprice, 
        x = ~Lag, 
        y = ~Correlation, 
        type = "bar", 
        name = "CCF_ipp_rprice",
        width = 1000,
        height = 400) %>%
  layout(xaxis = list(title = "Lag (Months)"),
         yaxis = list(title = "Cross-Correlation"),
         shapes = list(
           list(type = "line",x0 = 0,x1=1,xref='paper', y0 = 2 / sqrt(length(pricedata_comb$ipp)), 
                y1 = 2 / sqrt(length(pricedata_comb$ipp)), line = list(dash = "dash", color = "red")),
           list(type = "line", x0 = 0,x1=1,xref='paper', y0 = -2 / sqrt(length(pricedata_comb$ipp)), 
                y1 = -2 / sqrt(length(pricedata_comb$ipp)), line = list(dash = "dash", color = "red"))
         ))


```
:::
:::

::: {.fragment .fade-in-then-out fragment-index="3"}
```{r}
#|label: ccf2


ccf_ipp_fprice <- ccf(pricedata_comb$ipp,pricedata_comb$farmgate,plot = F,lag.max = 12)


ccfDF_ipp_fprice <- data.frame(
  Lag = ccf_ipp_fprice$lag,
  Correlation = ccf_ipp_fprice$acf
)

plot_ly(ccfDF_ipp_fprice, 
        x = ~Lag, 
        y = ~Correlation, 
        type = "bar", 
        name = "CCF_ipp_fprice",
        width = 1000,
        height = 400) %>%
  layout(xaxis = list(title = "Lag (Months)"),
         yaxis = list(title = "Cross-Correlation"),
         shapes = list(
           list(type = "line",x0 = 0,x1=1,xref='paper', y0 = 2 / sqrt(length(pricedata_comb$ipp)), 
                y1 = 2 / sqrt(length(pricedata_comb$ipp)), line = list(dash = "dash", color = "red")),
           list(type = "line", x0 = 0,x1=1,xref='paper', y0 = -2 / sqrt(length(pricedata_comb$ipp)), 
                y1 = -2 / sqrt(length(pricedata_comb$ipp)), line = list(dash = "dash", color = "red"))
         ))


```
:::

::: {.fragment .fade-in-then-out fragment-index="4"}
```{r}
#|label: ccf3


ccf_rprice_fprice <- ccf(pricedata_comb$rprice,pricedata_comb$farmgate,plot = F,lag.max = 12)


ccfDF_rprice_fprice <- data.frame(
  Lag = ccf_rprice_fprice$lag,
  Correlation = ccf_rprice_fprice$acf
)

plot_ly(ccfDF_rprice_fprice, 
        x = ~Lag, 
        y = ~Correlation, 
        type = "bar", 
        name = "CCF_rprice_fprice",
        width = 1000,
        height = 400) %>%
  layout(xaxis = list(title = "Lag (Months)"),
         yaxis = list(title = "Cross-Correlation"),
         shapes = list(
           list(type = "line",x0 = 0,x1=1,xref='paper', y0 = 2 / sqrt(length(pricedata_comb$ipp)), 
                y1 = 2 / sqrt(length(pricedata_comb$ipp)), line = list(dash = "dash", color = "red")),
           list(type = "line", x0 = 0,x1=1,xref='paper', y0 = -2 / sqrt(length(pricedata_comb$ipp)), 
                y1 = -2 / sqrt(length(pricedata_comb$ipp)), line = list(dash = "dash", color = "red"))
         ))


```
:::

::: {.fragment .fade-in-then-out fragment-index="5"}
```{r}
#| label: granger1
#| echo: false

# Create lagged series (optional: use VARselect to pick lag)

# Run Granger test with lag = 3
granger1 <- grangertest(rprice ~ ipp, 
                        order = 2, 
                        data = pricedata_comb)

granger2 <- grangertest(farmgate ~ ipp, 
                        order = 2, 
                        data = pricedata_comb)

granger3 <- grangertest(farmgate ~ rprice, 
                        order = 6, 
                        data = pricedata_comb)


granger_summary <- tribble(
  ~Relationship,              ~Lag_Order, ~F_Statistic, ~p_Value, ~Significant,
  "Global (IPP) ‚Üí Local Retail",               2,    round(granger1$`F`[2], 3),  round(granger1$`Pr(>F)`[2], 4), ifelse(granger1$`Pr(>F)`[2] < 0.05, "Yes", "No"),
  "Global (IPP) ‚Üí Local Farmgate",            2,    round(granger2$`F`[2], 3),  round(granger2$`Pr(>F)`[2], 4), ifelse(granger2$`Pr(>F)`[2] < 0.05, "Yes", "No"),
  "Local Retail ‚Üí Local Farmgate",            6,    round(granger3$`F`[2], 3),  round(granger3$`Pr(>F)`[2], 4), ifelse(granger3$`Pr(>F)`[2] < 0.05, "Yes", "No")
)

kable(granger_summary, format = "markdown", 
      caption = "Granger Causality Summary table at maximum lags with significant granger causality")


```
:::

::: {.fragment .fade-in-then-out fragment-index="6"}
```{dot}

digraph {
  rankdir = LR
  graph [fontname="Helvetica"]
  node  [fontname="Helvetica", shape=box, style=filled, fillcolor=lightyellow]
  edge  [fontname="Helvetica"]

  A [label="üåç Global Price"]
  B [label="üõí Local Retail Price"]
  C [label="üöú Farmgate Price"]

  A -> B [label="Lag 0‚Äì2 months", color="darkgreen"]
  A -> C [label="Lag 0‚Äì3 months (indirect)", style="dashed", color="darkorange"]
  B -> C [label="Lag 0‚Äì6 months", color="steelblue"]
}

```
:::
:::

## Effect on Rice Inflation {.tiny-text auto-animate="true"}

Since the start of 2025, declining global and local rice prices have contributed to negative rice inflation, easing upward pressure on overall prices. Given rice's high weight in the consumer basket, this drop has significantly helped slow down headline inflation.

```{r}
base_plot |> 
  add_lines(data = data_external[["riceinf"]] |> 
              filter(date>=ymd("2016-01-01")),
            x=~date,
            y=~Rice,
            name = "Rice inflation rate",
            line = list(color = "#fbbb18", width = 1),
            fill = "tozeroy",
            fillcolor = "rgba(254, 234, 22,0.3)",
            yaxis="y2",
            hovertemplate = paste0(
                        "Rice Inflation: ",
                        "%{y:,.2f} %<extra></extra>"
                      )
            ) |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    yaxis2 = list(title = "Rice Inflation (%)", 
                  overlaying = "y",
                  side = "right", 
                  showgrid = FALSE,
                  titlefont = list(size = 14),
                  tickfont = list(size = 12),
                  automargin = TRUE),
    margin = list(l = 50, r = 50, t = 50, b = 50)
  )

```


## Imports and stock levels {.tiny-text auto-animate="true"}

::: r-stack
::: {.fragment .fade-out .extra-tiny-text fragment-index="2"}
**Imports** 

Since early 2025, both global rice prices and domestic retail and farmgate prices in the Philippines have been on a gradual downward trend, yet import volumes have remained erratic rather than steadily rising. Import volume have oscillated, with notable spikes in April and June. This suggests non-price related factors influencing trade dynamics such as opportunistic buying when import parity margins widened; shifts in government import policies; traders and authorities adjusting to fluctuating demand forecasts or logistical bottlenecks.

```{r}

base_plot |> 
    add_lines(data = data_external[["imports"]] |> 
              filter(date>=ymd("2016-01-01")),
            x=~date,
            y=~Imports,
            name = "Rice imports",
            line = list(color = "#fbbb18", width = 1),
            fill = "tozeroy",
            fillcolor = "rgba(254, 234, 22,0.3)",
            yaxis="y2",
            hovertemplate = paste0(
                        "Rice imports: ",
                        "%{y:,.2f} mt<extra></extra>"
                      )
            ) |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    yaxis2 = list(title = "Rice imports (mt)", 
                  overlaying = "y",
                  side = "right", 
                  showgrid = FALSE,
                  titlefont = list(size = 14),
                  tickfont = list(size = 12),
                  automargin = TRUE),
    margin = list(l = 50, r = 50, t = 50, b = 50)
  )


```
:::

::: {.fragment .fade-in-then-out .tiny-text fragment-index="2"}
**Commercial Stocks**

With both global and domestic rice prices on a downward trend, commercial stocks also declined due to reduced incentive for commercial traders to stockpile rice, as holding large inventories in a falling price environment can lead to financial losses. To maintain liquidity, traders are more likely to release existing stock into the market to avoid future losses, and may delay new imports or local purchases, anticipating even lower prices ahead.

```{r}

base_plot |> 
    add_lines(data = data_external[["stocks"]] |> 
              filter(date>=ymd("2016-01-01"),
                     Stock == "Commercial"),
            x=~date,
            y=~Inventory,
            name = ~Stock,
            # color = ~Stock,
            customdata = ~Stock,
            # fillcolor = ~Stock,
            line = list(color = "#fbbb18", width = 1),
            fill = "tozeroy",
            fillcolor = "rgba(254, 234, 22,0.3)",
            yaxis="y2",
            hovertemplate = paste0(
                        "%{customdata} Stocks: ",
                        "%{y:,.2f} mt<extra></extra>"
                      )
            ) |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    yaxis2 = list(title = "Rice stocks (mt)", 
                  overlaying = "y",
                  side = "right", 
                  showgrid = FALSE,
                  titlefont = list(size = 14),
                  tickfont = list(size = 12),
                  automargin = TRUE),
    margin = list(l = 50, r = 50, t = 50, b = 50)
  )


```
:::

::: {.fragment .fade-in-then-out .tiny-text fragment-index="3"}
**Household Stocks**

For households, gradually decreasing rice prices led to stable or slightly declining household stocks. Consumers have less urgency to purchase in bulk or hoard supplies, since there is no perceived threat of price spikes or shortages and they may buy only what is needed, anticipating continued or stable affordability in the near term.

```{r}

base_plot |> 
    add_lines(data = data_external[["stocks"]] |> 
              filter(date>=ymd("2016-01-01"),
                     Stock == "Household"),
            x=~date,
            y=~Inventory,
            name = ~Stock,
            # color = ~Stock,
            customdata = ~Stock,
            # fillcolor = ~Stock,
            line = list(color = "#fbbb18", width = 1),
            fill = "tozeroy",
            fillcolor = "rgba(254, 234, 22,0.3)",
            yaxis="y2",
            hovertemplate = paste0(
                        "%{customdata} Stocks: ",
                        "%{y:,.2f} mt<extra></extra>"
                      )
            ) |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    yaxis2 = list(title = "Rice stocks (mt)", 
                  overlaying = "y",
                  side = "right", 
                  showgrid = FALSE,
                  titlefont = list(size = 14),
                  tickfont = list(size = 12),
                  automargin = TRUE),
    margin = list(l = 50, r = 50, t = 50, b = 50)
  )


```
:::

::: {.fragment .fade-in-then-out .tiny-text fragment-index="4"}
**Government/NFA Stocks**

With decreasing prices, buffer stock increases as the government, through NFA,rebuild or augment buffer stocks at a lower cost. With cheaper local procurement or global imports, the government have increased its reserves without putting as much pressure on procurement budgets and storage capacity.

```{r}

base_plot |> 
    add_lines(data = data_external[["stocks"]] |> 
              filter(date>=ymd("2016-01-01"),
                     Stock == "NFA"),
            x=~date,
            y=~Inventory,
            name = ~Stock,
            # color = ~Stock,
            customdata = ~Stock,
            # fillcolor = ~Stock,
            line = list(color = "#fbbb18", width = 1),
            fill = "tozeroy",
            fillcolor = "rgba(254, 234, 22,0.3)",
            yaxis="y2",
            hovertemplate = paste0(
                        "%{customdata} Stocks: ",
                        "%{y:,.2f} mt<extra></extra>"
                      )
            ) |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    yaxis2 = list(title = "Rice stocks (mt)", 
                  overlaying = "y",
                  side = "right", 
                  showgrid = FALSE,
                  titlefont = list(size = 14),
                  tickfont = list(size = 12),
                  automargin = TRUE),
    margin = list(l = 50, r = 50, t = 50, b = 50)
  )


```
:::

::: {.fragment .fade-in-then-out .tiny-text fragment-index="5"}
**Total Stocks**

The combined effect of declining commercial and household stocks, offset by increasing government stocks, leads to a mixed but generally stable total stock levels.

```{r}

base_plot |> 
    add_lines(data = data_external[["stocks"]] |> 
              filter(date>=ymd("2016-01-01"),
                     Stock == "Total"),
            x=~date,
            y=~Inventory,
            name = ~Stock,
            # color = ~Stock,
            customdata = ~Stock,
            # fillcolor = ~Stock,
            line = list(color = "#fbbb18", width = 1),
            fill = "tozeroy",
            fillcolor = "rgba(254, 234, 22,0.3)",
            yaxis="y2",
            hovertemplate = paste0(
                        "%{customdata} Stocks: ",
                        "%{y:,.2f} mt<extra></extra>"
                      )
            ) |> 
  layout(
    xaxis=list(range = c("2023-06-01", "2025-06-01")),
    yaxis2 = list(title = "Rice stocks (mt)", 
                  overlaying = "y",
                  side = "right", 
                  showgrid = FALSE,
                  titlefont = list(size = 14),
                  tickfont = list(size = 12),
                  automargin = TRUE),
    margin = list(l = 50, r = 50, t = 50, b = 50)
  )


```
:::
:::

## Year-on-Year comparison (2024v2025) {.tiny-text auto-animate="true"}


:::: {.r-stack}

::: {.fragment .fade-in-then-out fragment-index=1 .extra-tiny-text}
**Year-on-Year Retail Price change**

With the continued decline in global rice prices throughout 2025, domestic retail prices have become significantly lower compared to the same months in 2024. This is reflected in the growing year-on-year (YoY) decline observed from January to June. The drop in international prices reduces import costs, intensifies market competition, and exerts downward pressure on local retail prices. As traders and importers adjust to these lower global benchmarks, the price reductions are gradually passed on to consumers, further accelerating the YoY decline in domestic retail prices.

**As of June 2025, the average domestic retail price is 17% lower than in June 2024**



```{r}
#| label: retail_yoy
#| echo: false

plot_ly(width="1000",height="500") %>%
        add_bars(data = pricedata_yoy,
            x=~date,
            y=~rprice_yoy,
            yaxis = "y",
            name = "Retail Price Year on Year (YOY) Decline",
            marker = list(
              color = "#fbbb18",
              line = list(color = "brown", width = 1.5)
            ),
            legendgroup = "domestic prices",
            hovertemplate = paste0(
                        "%{fullData.name} : ",
                        "%{y:,.2f} %<extra></extra>"
                      )
            ) |> 
  add_lines(data =data_edited[["wholesale_prices"]] |> 
              filter(type =="rmr"),
            x = ~date,
            y = ~price, yaxis="y2",
            legendgroup = "domestic prices",
            name = "Wholesale Price (RMR)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "darkorange")
  ) |> 
  add_lines(data =data_edited[["retail_prices"]] |> 
              filter(type =="rmr"),
            x = ~date,
            y = ~price, yaxis="y2",
            legendgroup = "domestic prices",
            name = "Retail Price (RMR)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "darkgreen")
  ) |> 
  add_lines(data =  data_edited[["farmgate_prices"]],
            x = ~date, yaxis="y2",
            legendgroup = "domestic prices",
            y = ~farmgate_rice,
            name = "Farmgate price (rice equivalent)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "blue")) |> 
  add_lines(data =data_edited[["ipp_ave"]],
            x=~date,
            y=~price, yaxis="y2",
            legendgroup = "global prices",
            name = "Average Import parity Price (IPP) across major importing countries",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "black", dash = "dash")) |>
    add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Vietnam 25%"),
            x=~date,
            y=~ipp, yaxis="y2",
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#FF3F3F", dash = "dash")) |>
      add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Thai 25%"),
            x=~date,
            y=~ipp, yaxis="y2",
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#65DA65", dash = "dash")) |>
      add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Pakistan 25%"),
            x=~date,
            y=~ipp, yaxis="y2",
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#EE82EE", dash = "dash")) |>
layout(hovermode='x unified',
       xaxis = list(title = "Date",visible = T , showgrid=T,
                      range = c("2024-12-15", "2025-06-15")),
         yaxis2 = list(title = "Rice Price (‚Ç±/kg)",
                       overlaying = "y",
                       side = "left", 
                       visible =T , 
                       titlefont = list(size = 14),
                       tickfont = list(size = 12),
                       automargin = TRUE,
                       showgrid=T),
       yaxis = list(title = "% Decline ",
                    range = c(0, 20),
                  side = "right", 
                  showgrid = F),
       legend = list(
         x=0,
         y=-0.5,
         xanchor='left',
         yanchor='top',
         orientation = 'h'
       ),
       
         showlegend = T) |> 
  rangeslider()


```
:::


::: {.fragment .fade-in-then-out fragment-index=2 .extra-tiny-text}

**Year-on-Year Farmgate Price change**

Since we have established that retail prices influence and lead farmgate prices, a similar pattern is expected for farmgate prices‚Äîshowing an increasing trend in year-on-year (YoY) percentage decline as retail prices continue to fall. 

**As of June 2025, the average domestic farmgate price is 31% lower than in June 2024**


```{r}

plot_ly(width="1000",height="500") %>%
        add_bars(data = pricedata_yoy,
            x=~date,
            y=~farmgate_yoy ,
            yaxis = "y",
            name = "Farmgate Price Year on Year (YOY) Decline",
            marker = list(
              color = "#fbbb18",
              line = list(color = "brown", width = 1.5)
            ),
            legendgroup = "domestic prices",
            hovertemplate = paste0(
                        "%{fullData.name} : ",
                        "%{y:,.2f} %<extra></extra>"
                      )
            ) |> 
  add_lines(data =data_edited[["wholesale_prices"]] |> 
              filter(type =="rmr"),
            x = ~date,
            y = ~price, yaxis="y2",
            legendgroup = "domestic prices",
            name = "Wholesale Price (RMR)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "darkorange")
  ) |> 
  add_lines(data =data_edited[["retail_prices"]] |> 
              filter(type =="rmr"),
            x = ~date,
            y = ~price, yaxis="y2",
            legendgroup = "domestic prices",
            name = "Retail Price (RMR)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "darkgreen")
  ) |> 
  add_lines(data =  data_edited[["farmgate_prices"]],
            x = ~date, yaxis="y2",
            legendgroup = "domestic prices",
            y = ~farmgate_rice,
            name = "Farmgate price (rice equivalent)",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"),
            line = list(color = "blue")) |> 
  add_lines(data =data_edited[["ipp_ave"]],
            x=~date,
            y=~price, yaxis="y2",
            legendgroup = "global prices",
            name = "Average Import parity Price (IPP) across major importing countries",
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "black", dash = "dash")) |>
    add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Vietnam 25%"),
            x=~date,
            y=~ipp, yaxis="y2",
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#FF3F3F", dash = "dash")) |>
      add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Thai 25%"),
            x=~date,
            y=~ipp, yaxis="y2",
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#65DA65", dash = "dash")) |>
      add_lines(data =data_edited[["ipp"]] |> 
                filter(type == "Pakistan 25%"),
            x=~date,
            y=~ipp, yaxis="y2",
            legendgroup = "global prices",
            name = ~paste(type," IPP"),
            hovertemplate = paste0("%{fullData.name}: ",
                                   "‚Ç± %{y:.2f}<extra></extra>"), 
            line = list(color = "#EE82EE", dash = "dash")) |>
layout(hovermode='x unified',
       xaxis = list(title = "Date",visible = T , showgrid=T,
                      range = c("2024-12-15", "2025-06-15")),
         yaxis2 = list(title = "Rice Price (‚Ç±/kg)",
                       overlaying = "y",
                       side = "left", 
                       visible =T , 
                       titlefont = list(size = 14),
                       tickfont = list(size = 12),
                       automargin = TRUE,
                       showgrid=T),
       yaxis = list(title = "% Decline ",
                    # range = c(0, 20),
                  side = "right", 
                  showgrid = F),
       legend = list(
         x=0,
         y=-0.5,
         xanchor='left',
         yanchor='top',
         orientation = 'h'
       ),
       
         showlegend = T) |> 
  rangeslider()


```

:::

::: {.fragment .fade-in-then-out fragment-index=3 .tiny-text}

**Comparing Retail and Farmgate YoY**

A sharper increasing trend for YoY % decline in farmgate prices than retail suggests farmers are absorbing more of the price drop, leading to reduced incomes and a widening gap between what consumers pay and what farmers earn.

```{r}

plot_ly(width="1000",height="500") %>%
        add_lines(data = pricedata_yoy,
            x=~date,
            y=~farmgate_yoy ,
            name = "Farmgate Price Year on Year (YOY) Decline",
            line = list(color = "darkorange"),
            hovertemplate = paste0(
                        "%{fullData.name} : ",
                        "%{y:,.2f} %<extra></extra>"
                      )
            ) |> 
          add_lines(data = pricedata_yoy,
            x=~date,
            y=~rprice_yoy ,
            name = "Retail Price Year on Year (YOY) Decline",
            line = list(color = "darkgreen"),
            hovertemplate = paste0(
                        "%{fullData.name} : ",
                        "%{y:,.2f} %<extra></extra>"
                      )
            ) |> 
  layout(hovermode='x unified',
       xaxis = list(title = "Date",visible = T , showgrid=T,
                      range = c("2024-12-15", "2025-06-15")),
       yaxis = list(title = "% Decline ",
                    # range = c(0, 20),
                  side = "right", 
                  showgrid = F),
       legend = list(
         x=0,
         y=-0.5,
         xanchor='left',
         yanchor='top',
         orientation = 'h'
       ),
       
         showlegend = T) |> 
  rangeslider()


```
:::
::::


## Key Takeaways {.tiny-text auto-animate=true}

:::{.tiny-text}

- **Global & Local Price Trends**  
  ‚Äì All price series (global IPP, wholesale, retail, farmgate) have been on a **gradual downward trajectory** since mid‚Äë2024, with local markets responding within 2‚Äì4 months of global shifts.

- **Price Transmission Pathway**  
  ‚Äì **Global ‚Üí Retail**: Strong Granger causality at lag 2 $(p=0.022)$ and CCF peaks at lags 0‚Äì4.  
  ‚Äì **Retail ‚Üí Farmgate**: Significant Granger causality at lag 6 $(p =0.043)$ and CCF peaks at lags 0‚Äì2.  
  ‚Äì **Global ‚Üí Farmgate**: High CCF at lags 0‚Äì3 but **no direct Granger effect**, indicating **indirect transmission** via retail.

- **Inflation Impact**  
  ‚Äì Persistent price declines have driven **negative rice inflation** in 2025, helping to **cool headline CPI** given rice‚Äôs large weight in the food basket.

- **Import Dynamics**  
  ‚Äì Despite falling prices, **import volumes remain volatile**, with spikes in April and June 2025‚Äîsuggesting policy shifts, opportunistic buying, or logistical factors outweigh pure price incentives.

- **Stock Adjustments**  
  ‚Äì **Commercial & Household Stocks** have eased as traders and consumers release stocks in a falling‚Äëprice environment.  
  ‚Äì **Government/NFA Stocks** have been rebuilt at lower cost, stabilizing overall reserve levels.

- **Year‚Äëon‚ÄëYear Declines**  
  ‚Äì **Retail prices**: June 2025 are **17% lower** than June 2024.  
  ‚Äì **Farmgate prices**: June 2025 are **31% lower**, indicating **farmers absorb most of the downturn** and signaling a widening farm‚Äëretail margin.
:::

## 

::: thank-you
::: {style="font-size: 2.5em; font-weight: bold; text-align: center;"}
Thank You!!
:::

::: {style="margin-top: 1em; font-size: 1.2em; text-align: center;"}
Questions or feedback?<br> <strong>philrice.dataanalytics\@gmail.com</strong>
:::
:::

